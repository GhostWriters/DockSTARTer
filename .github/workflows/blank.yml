name: CI

on: [push]

jobs:

  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: validate
      run: |
        ls ${GITHUB_WORKSPACE}
        curl -fsSL https://raw.githubusercontent.com/nemchik/ShellSuite/master/shellsuite.sh -o shellsuite-${GITHUB_SHA}.sh && bash shellsuite-${GITHUB_SHA}.sh -p "${PWD}" -v "bashate" -f " -i E006"
        curl -fsSL https://raw.githubusercontent.com/nemchik/ShellSuite/master/shellsuite.sh -o shellsuite-${GITHUB_SHA}.sh && bash shellsuite-${GITHUB_SHA}.sh -p "${PWD}" -v "shellcheck" -f " -x"
        curl -fsSL https://raw.githubusercontent.com/nemchik/ShellSuite/master/shellsuite.sh -o shellsuite-${GITHUB_SHA}.sh && bash shellsuite-${GITHUB_SHA}.sh -p "${PWD}" -v "shfmt" -f " -s -i 4 -ci -sr -d"
        "docker run --rm -v ${PWD}:/code pipelinecomponents/yamllint yamllint -d '{extends: default, rules: {document-start: {present: false}, line-length: disable}}' $(git ls-files '*.yaml' '*.yml')"

  run:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: run
      run: while IFS= read -r line; do echo; sudo bash ./main.sh -vt "${line}" || exit 1; echo; done < <(ls -A .scripts/*.sh | sed -E 's/^\.scripts\/(\w+)\.sh$/\1/')
